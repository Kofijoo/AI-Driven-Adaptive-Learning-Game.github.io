<!DOCTYPE html>
<html>
<head>
    <title>Interactive Characters - Little Explorers</title>
    <style>
        body { margin: 0; background: linear-gradient(135deg, #87CEEB, #98FB98); color: white; font-family: 'Comic Sans MS', Arial; }
        canvas { width: 100%; height: 75vh; display: block; }
        #ui { position: absolute; top: 0; left: 0; right: 0; padding: 15px; background: rgba(0,0,0,0.7); }
        #dialogue { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
                   background: rgba(255,255,255,0.95); color: #333; padding: 20px; border-radius: 20px; 
                   max-width: 500px; text-align: center; font-size: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #character-info { position: absolute; top: 80px; left: 20px; background: rgba(255,255,255,0.9); 
                         color: #333; padding: 15px; border-radius: 15px; max-width: 200px; }
        .api-setup { display: inline-block; margin: 5px; }
        input { padding: 8px; border-radius: 5px; border: none; margin: 3px; }
        button { padding: 10px 15px; border-radius: 8px; border: none; background: #4CAF50; color: white; cursor: pointer; margin: 3px; }
        button:hover { background: #45a049; }
        .character-name { font-size: 16px; font-weight: bold; color: #2E8B57; }
    </style>
</head>
<body>
    <div id="ui">
        <div style="display: inline-block;">
            <strong>🧪 Little Explorers Lab</strong> - Click characters to chat!
        </div>
        <div class="api-setup">
            <input type="password" id="deepseek-key" placeholder="DeepSeek API Key" style="width: 200px;">
            <button onclick="setApiKey()">Set API Key</button>
        </div>
    </div>
    
    <div id="character-info" style="display: none;">
        <div class="character-name" id="char-name">Dr. Maya</div>
        <div id="char-description">Science Teacher</div>
        <div style="margin-top: 10px; font-size: 14px;" id="char-personality"></div>
    </div>
    
    <canvas id="canvas"></canvas>
    <div id="dialogue" style="display: none;"></div>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script>
        let apiKey = null;
        let currentCharacter = null;
        let conversationHistory = [];
        
        // Character definitions
        const characters = {
            maya: {
                name: "Dr. Maya",
                role: "Science Teacher",
                personality: "Enthusiastic, patient, loves making science fun and simple",
                position: { x: -3, y: 0, z: 0 },
                color: { r: 0.8, g: 0.4, b: 0.6 },
                prompt: "You are Dr. Maya, a warm and enthusiastic science teacher for 4-7 year olds. You love making science magical and fun. Use simple words, ask curious questions, and always encourage exploration. Keep responses to 1-2 sentences. Use emojis and excited language."
            },
            alex: {
                name: "Alex the Explorer",
                role: "Adventure Guide",
                personality: "Curious, brave, always ready for discovery",
                position: { x: 0, y: 0, z: 0 },
                color: { r: 0.4, g: 0.8, b: 0.9 },
                prompt: "You are Alex, a young adventure guide who loves exploring with kids. You're curious, brave, and always excited about discoveries. Speak like a friendly older sibling. Use simple words and ask 'what if' questions. Keep responses short and playful."
            },
            luna: {
                name: "Luna the Helper",
                role: "Lab Assistant",
                personality: "Gentle, helpful, loves explaining how things work",
                position: { x: 3, y: 0, z: 0 },
                color: { r: 0.9, g: 0.8, b: 0.4 },
                prompt: "You are Luna, a gentle and helpful lab assistant. You love explaining how things work in simple ways. You're patient, kind, and always ready to help. Use gentle, encouraging language and ask if children need help understanding anything."
            }
        };
        
        // Create 3D scene
        const canvas = document.getElementById('canvas');
        const engine = new BABYLON.Engine(canvas, true);
        const scene = new BABYLON.Scene(engine);
        
        // Camera and lighting
        const camera = new BABYLON.ArcRotateCamera('camera', 0, Math.PI/3, 12, BABYLON.Vector3.Zero(), scene);
        scene.activeCamera = camera;
        
        const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
        light.intensity = 0.8;
        
        // Create ground
        const ground = BABYLON.MeshBuilder.CreateGround('ground', {size: 15}, scene);
        const groundMat = new BABYLON.StandardMaterial('groundMat', scene);
        groundMat.diffuseColor = new BABYLON.Color3(0.9, 0.9, 0.95);
        ground.material = groundMat;
        
        // Create characters
        const characterMeshes = {};
        Object.keys(characters).forEach(charId => {
            const char = characters[charId];
            
            // Body (cylinder for human-like shape)
            const body = BABYLON.MeshBuilder.CreateCylinder(`${charId}_body`, {height: 2, diameter: 0.8}, scene);
            body.position = new BABYLON.Vector3(char.position.x, 1, char.position.z);
            
            // Head (sphere)
            const head = BABYLON.MeshBuilder.CreateSphere(`${charId}_head`, {diameter: 0.6}, scene);
            head.position = new BABYLON.Vector3(char.position.x, 2.3, char.position.z);
            
            // Materials
            const bodyMat = new BABYLON.StandardMaterial(`${charId}_bodyMat`, scene);
            bodyMat.diffuseColor = new BABYLON.Color3(char.color.r, char.color.g, char.color.b);
            body.material = bodyMat;
            
            const headMat = new BABYLON.StandardMaterial(`${charId}_headMat`, scene);
            headMat.diffuseColor = new BABYLON.Color3(0.9, 0.8, 0.7); // Skin tone
            head.material = headMat;
            
            // Store references
            characterMeshes[charId] = { body, head, data: char };
            
            // Floating animation
            let time = Math.random() * Math.PI * 2;
            scene.registerBeforeRender(() => {
                time += 0.01;
                const offset = Math.sin(time) * 0.1;
                body.position.y = 1 + offset;
                head.position.y = 2.3 + offset;
            });
        });
        
        // Click interaction
        scene.onPointerObservable.add((pointerInfo) => {
            if (pointerInfo.pickInfo.hit) {
                const mesh = pointerInfo.pickInfo.pickedMesh;
                const charId = Object.keys(characterMeshes).find(id => 
                    characterMeshes[id].body === mesh || characterMeshes[id].head === mesh
                );
                
                if (charId) {
                    selectCharacter(charId);
                    startConversation(charId);
                }
            }
        });
        
        engine.runRenderLoop(() => scene.render());
        window.addEventListener('resize', () => engine.resize());
        
        // Character interaction functions
        function selectCharacter(charId) {
            currentCharacter = charId;
            const char = characters[charId];
            
            document.getElementById('char-name').textContent = char.name;
            document.getElementById('char-description').textContent = char.role;
            document.getElementById('char-personality').textContent = char.personality;
            document.getElementById('character-info').style.display = 'block';
        }
        
        async function startConversation(charId) {
            const dialogue = document.getElementById('dialogue');
            dialogue.style.display = 'block';
            dialogue.innerHTML = `${characters[charId].name} is thinking... 💭`;
            
            try {
                const response = await generateCharacterResponse(charId, 'greeting');
                showDialogue(characters[charId].name, response);
            } catch (error) {
                showDialogue(characters[charId].name, getFallbackResponse(charId));
            }
        }
        
        async function generateCharacterResponse(charId, context) {
            if (!apiKey) {
                return getFallbackResponse(charId);
            }
            
            const char = characters[charId];
            const contextPrompt = context === 'greeting' ? 
                'A child just clicked on you to start a conversation. Greet them warmly and ask what they want to explore or learn about.' :
                'Continue the conversation with the child about science and exploration.';
            
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'system', content: char.prompt },
                            { role: 'user', content: contextPrompt }
                        ],
                        max_tokens: 60,
                        temperature: 0.8
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.choices[0].message.content.trim();
                }
            } catch (error) {
                console.log('API failed, using fallback');
            }
            
            return getFallbackResponse(charId);
        }
        
        function getFallbackResponse(charId) {
            const responses = {
                maya: [
                    "Hi there, little scientist! 🧪 Ready to discover something amazing today?",
                    "Hello! I'm Dr. Maya! What makes you curious about the world around us?",
                    "Welcome to our lab! 🌟 What would you like to explore first?"
                ],
                alex: [
                    "Hey there, explorer! 🗺️ Ready for an adventure in science?",
                    "Hi! I'm Alex! What mystery should we solve together today?",
                    "Welcome, brave explorer! 🚀 What discovery are you excited about?"
                ],
                luna: [
                    "Hello, dear! 🌙 I'm Luna, and I love helping kids learn! What can I explain for you?",
                    "Hi there! 💫 I'm here to help you understand how amazing things work!",
                    "Welcome! 🌸 What would you like to learn about today? I'm here to help!"
                ]
            };
            
            const charResponses = responses[charId] || responses.maya;
            return charResponses[Math.floor(Math.random() * charResponses.length)];
        }
        
        function showDialogue(characterName, message) {
            const dialogue = document.getElementById('dialogue');
            dialogue.innerHTML = `<strong>${characterName}:</strong><br>${message}`;
            
            // Auto-hide after 6 seconds
            setTimeout(() => {
                dialogue.style.display = 'none';
            }, 6000);
        }
        
        function setApiKey() {
            apiKey = document.getElementById('deepseek-key').value;
            if (apiKey) {
                alert('API key set! Now click on characters to chat with them! 🎉');
            }
        }
        
        // Initial greeting
        setTimeout(() => {
            const dialogue = document.getElementById('dialogue');
            dialogue.style.display = 'block';
            dialogue.innerHTML = '<strong>Welcome to Little Explorers Lab!</strong><br>Click on Dr. Maya (pink), Alex (blue), or Luna (yellow) to start chatting! 🧪✨';
            
            setTimeout(() => dialogue.style.display = 'none', 5000);
        }, 2000);
    </script>
</body>
</html>