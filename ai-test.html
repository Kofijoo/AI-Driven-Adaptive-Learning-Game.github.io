<!DOCTYPE html>
<html>
<head>
    <title>AI Puffy Test</title>
    <style>
        body { margin: 0; background: #222; color: white; font-family: Arial; }
        canvas { width: 100%; height: 70vh; display: block; }
        #controls { padding: 20px; background: #333; }
        #info { margin-bottom: 10px; }
        #dialogue { background: rgba(255,255,255,0.9); color: black; padding: 15px; border-radius: 10px; margin: 10px 0; }
        input { width: 300px; padding: 5px; margin: 5px; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="controls">
        <div id="info">AI-Powered Puffy Test</div>
        <div>
            <input type="password" id="deepseek-key" placeholder="DeepSeek API Key">
            <input type="password" id="openrouter-key" placeholder="OpenRouter API Key">
            <button onclick="setApiKeys()">Set API Keys</button>
        </div>
        <div>
            <button onclick="testAI()">Test AI Response</button>
            <button onclick="clearDialogue()">Clear</button>
        </div>
        <div id="dialogue" style="display: none;"></div>
    </div>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script>
        let apiKeys = { deepseek: null, openrouter: null };
        
        // Create 3D scene
        const canvas = document.getElementById('canvas');
        const engine = new BABYLON.Engine(canvas, true);
        const scene = new BABYLON.Scene(engine);
        
        const camera = new BABYLON.ArcRotateCamera('camera', 0, Math.PI/3, 8, BABYLON.Vector3.Zero(), scene);
        camera.attachControls(canvas, true);
        
        const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
        
        const puffy = BABYLON.MeshBuilder.CreateSphere('puffy', {diameter: 2}, scene);
        puffy.position.y = 1;
        
        const puffyMat = new BABYLON.StandardMaterial('puffyMat', scene);
        puffyMat.diffuseColor = new BABYLON.Color3(0.7, 0.9, 1.0);
        puffyMat.emissiveColor = new BABYLON.Color3(0.1, 0.2, 0.3);
        puffy.material = puffyMat;
        
        // Floating animation
        let time = 0;
        scene.registerBeforeRender(() => {
            time += 0.02;
            puffy.position.y = 1 + Math.sin(time) * 0.3;
        });
        
        engine.runRenderLoop(() => scene.render());
        
        // API functions
        function setApiKeys() {
            apiKeys.deepseek = document.getElementById('deepseek-key').value;
            apiKeys.openrouter = document.getElementById('openrouter-key').value;
            
            if (apiKeys.deepseek || apiKeys.openrouter) {
                document.getElementById('info').innerHTML = 'API Keys set! Click "Test AI Response"';
            }
        }
        
        async function testAI() {
            const dialogue = document.getElementById('dialogue');
            dialogue.style.display = 'block';
            dialogue.innerHTML = 'Puffy is thinking...';
            
            try {
                const response = await generateAIResponse();
                dialogue.innerHTML = `Puffy says: "${response}"`;
            } catch (error) {
                dialogue.innerHTML = `Error: ${error.message}`;
            }
        }
        
        async function generateAIResponse() {
            if (!apiKeys.deepseek && !apiKeys.openrouter) {
                throw new Error('Please set at least one API key');
            }
            
            const prompt = "You are Puffy, a friendly cloud character who guides 4-7 year old children through science experiments. Respond in 1-2 simple sentences with encouraging, curious language. Ask a question that makes children think.";
            
            // Try DeepSeek first
            if (apiKeys.deepseek) {
                try {
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKeys.deepseek}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                { role: 'system', content: prompt },
                                { role: 'user', content: 'Child just clicked on you to interact. Greet them and ask what they want to explore.' }
                            ],
                            max_tokens: 50,
                            temperature: 0.7
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content.trim();
                    }
                } catch (error) {
                    console.log('DeepSeek failed, trying fallback');
                }
            }
            
            // Fallback responses
            const fallbacks = [
                "Hello! I'm Puffy! What science adventure should we try today?",
                "Hi there! I love exploring with curious kids like you! What makes you wonder?",
                "Welcome to our lab! What would you like to discover together?",
                "Hey explorer! Ready to learn something amazing? What interests you most?"
            ];
            
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }
        
        function clearDialogue() {
            document.getElementById('dialogue').style.display = 'none';
        }
        
        // Click Puffy to test
        scene.onPointerObservable.add((pointerInfo) => {
            if (pointerInfo.pickInfo.hit && pointerInfo.pickInfo.pickedMesh === puffy) {
                testAI();
            }
        });
    </script>
</body>
</html>